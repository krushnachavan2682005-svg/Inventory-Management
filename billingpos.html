<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Billing POS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== RESET ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: #f8fafc;
      height: 100vh;
      display: flex;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 240px;
      background: #0f172a;
      color: #fff;
      padding: 20px;
    }

    .sidebar h2 {
      color: #38bdf8;
      margin-bottom: 30px;
    }

    .sidebar a {
      display: block;
      padding: 12px;
      color: #cbd5f5;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #1e293b;
      color: #fff;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 20px;
      display: grid;
      grid-template-columns: 1.3fr 2fr 1.2fr;
      gap: 20px;
    }

    /* ===== PRODUCT SEARCH ===== */
    .products {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .products input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      margin-bottom: 16px;
    }

    .product {
      padding: 12px;
      border-radius: 10px;
      background: #f1f5f9;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .product:hover {
      background: #e0f2fe;
    }

    /* ===== BILL TABLE ===== */
    .bill {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px;
      font-size: 14px;
    }

    th {
      background: #f1f5f9;
      font-weight: 600;
    }

    td input {
      width: 50px;
      padding: 4px;
      text-align: center;
    }

    /* ===== SUMMARY ===== */
    .summary {
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .summary h3 {
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .total {
      font-size: 22px;
      font-weight: 700;
    }

    .pay-btn {
      background: #2563eb;
      color: #fff;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .pay-btn:hover {
      background: #1d4ed8;
    }

    .product.active {
      background: #38bdf8;
      color: #fff;
    }

    #productList {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
    }

    #productList::-webkit-scrollbar {
      width: 6px;
    }

    #productList::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 10px;
    }

    .bill {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);

      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    /* Header stays fixed */
    .bill table {
      width: 100%;
      border-collapse: collapse;
    }

    /* Scroll only the rows */
    .bill-body {
      flex: 1;
      overflow-y: auto;
    }

    /* Match column widths */
    .bill-body table {
      width: 100%;
    }

    /* Scrollbar styling */
    .bill-body::-webkit-scrollbar {
      width: 6px;
    }

    .bill-body::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 10px;
    }

    .delete-btn {
      background-color: #fd3f3f;
      /* red */
      color: #ffffff;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }

    .delete-btn:hover {
      background-color: #b91c1c;
      /* darker red */
    }

    .delete-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>InventorySys</h2>
    <a href="dashboard.html">Dashboard</a>
    <a class="active" href="#">Billing (POS)</a>
    <a href="Products.html">Products</a>
    <a href="inventory.html">Inventory</a>
    <a href="customer.html">Customer</a>
    <a href="report.html">Reports</a>
    <a href="setting.html">Settings</a>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- PRODUCT SEARCH -->
    <section id="productdiv" class="products">
      <input id="search" type="text" placeholder="Search product / Scan barcode" />

      <div id="productList">

      </div>
    </section>

    <!-- BILL TABLE -->
    <section class="bill">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Total</th>
            <th>Delete</th>
          </tr>
        </thead>
      </table>

      <div class="bill-body">
        <table>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>


    <!-- SUMMARY -->
    <section class="summary">
      <div>
        <h3>Bill Summary</h3>
        <div class="summary-row"><span>Subtotal</span><span id="subtotal">0</span></div>
        <div class="summary-row"><span>Tax (18%)</span><span id="tax">0</span></div>
        <div class="summary-row total"><span>Total</span><span id="total">0</span></div>
      </div>
      <button id="bill" class="pay-btn">Generate Bill</button>
    </section>

  </main>
  <script>
    const productContainer = document.getElementById("productList");
    const searchInput = document.getElementById("search");

    fetch("http://localhost:3000/allproduct")
      .then(res => res.json())
      .then(data => {
        data.forEach(e => {
          const div = document.createElement("div");
          div.classList.add("product"); // âœ… FIXED
          div.innerText = `${e.productname} - â‚¹${e.sellingprice}`;


          div.addEventListener("click", () => {
            document.querySelectorAll(".product").forEach(p =>
              p.classList.remove("active")
            );
            div.classList.add("active");

            const tbody = document.getElementById("tbody");
            const rows = tbody.querySelectorAll("tr");

            for (let row of rows) {
              if (row.dataset.name === e.productname) {
                const qtyInput = row.querySelector("input");
                const tdtotal = row.children[3]; // Total column
                const price = Number(e.sellingprice);
                const stock = Number(e.initialstock);

                let qty = Number(qtyInput.value) + 1;



                if (qty > stock) {
                  alert(`Only ${stock} quantity available`);
                  return;
                }

                qtyInput.value = qty;
                tdtotal.innerText = `${qty * price}`;
                updateSubtotal();

                return;
              }
            }



            const tr = document.createElement("tr");
            tr.dataset.id = e.id;
            tr.dataset.name = e.productname;
            let tdbutton = document.createElement("button")
            tdbutton.classList.add("delete-btn")
            tdbutton.innerText = "Delete"

            const tdproduct = document.createElement("td");
            tdproduct.innerText = e.productname;

            const tdquantity = document.createElement("td");
            const inptquantity = document.createElement("input");
            inptquantity.type = "number";
            inptquantity.value = 1;
            inptquantity.min = 1;
            tdquantity.appendChild(inptquantity);

            const tdprice = document.createElement("td");
            tdprice.innerText = `${e.sellingprice}`;

            const tdtotal = document.createElement("td");
            tdtotal.innerText = `${e.sellingprice}`;


            inptquantity.addEventListener("input", () => {
              if (Number(inptquantity.value) > Number(e.initialstock)) {
                alert(`Maximum available stock is ${e.initialstock}`);
                inptquantity.value = e.initialstock
              }
              tdtotal.innerText = inptquantity.value * e.sellingprice;

              updateSubtotal();


            });

            tr.appendChild(tdproduct);
            tr.appendChild(tdquantity);
            tr.appendChild(tdprice);
            tr.appendChild(tdtotal);
            tr.appendChild(tdbutton)

            tbody.appendChild(tr);
            updateSubtotal();



            tdbutton.addEventListener("click", function () {
              tr.remove()
              updateSubtotal()


            })
          });


          productContainer.appendChild(div);




        });


      });

    /* ðŸ” SEARCH FILTER */
    searchInput.addEventListener("input", () => {
      const searchValue = searchInput.value.toLowerCase();

      const products = document.querySelectorAll(".product");

      products.forEach(product => {
        const text = product.innerText.toLowerCase();

        product.style.display = text.includes(searchValue)
          ? "block"
          : "none";



      });
    });

    function updateSubtotal() {
      let subtotal = 0;

      document.querySelectorAll("#tbody tr").forEach(row => {
        subtotal += Number(row.children[3].innerText);
      });

      document.getElementById("subtotal").innerText = subtotal;

      let tax = document.getElementById("tax")


      tax.innerText = Math.floor(subtotal * 0.18);
      let total = Number(tax.innerText) + Number(subtotal)
      document.getElementById("total").innerText = total

    }
    let bill = document.getElementById("bill");

    bill.addEventListener("click", function () {
      const cartItems = [];

      document.querySelectorAll("#tbody tr").forEach(row => {
        cartItems.push({
          productId: row.dataset.id,
          name: row.children[0].innerText,
          qty: Number(row.children[1].querySelector("input").value),
          price: Number(row.children[2].innerText),
          total: Number(row.children[3].innerText)
        });
      });

      if (cartItems.length === 0) {
        alert("No items in bill");
        return;
      }

      // âœ… Save to localStorage
      localStorage.setItem("cartItems", JSON.stringify(cartItems));

      // Optional: save totals
      localStorage.setItem("billTotal", document.getElementById("total").innerText);

      console.log("Saved cart:", cartItems);



      const items = [];

      document.querySelectorAll("#tbody tr").forEach(row => {
        const productId = row.dataset.id;
        const qty = Number(row.children[1].querySelector("input").value);

        items.push({
          productId,
          qty
        });
      });

      if (items.length === 0) {
        alert("No items in bill");
        return;
      }

      fetch("http://localhost:3000/generate-bill", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          customerId,
          items
        })
      })
        .then(res => res.json())
        .then(data => {
          alert("Bill generated successfully âœ…");
          console.log(data);
        })
        .catch(err => {
          console.error(err);
          alert("Error generating bill âŒ");
        });
      window.location.replace("lastpavti.html")
    });

    // read query param
    const params = new URLSearchParams(window.location.search);
    const customerId = params.get("customerId");

    if (!customerId) {
      alert("No customer selected");
      window.location.href = "start.html"; // optional redirect
    }

    console.log("Customer ID:", customerId);
    fetch("http://localhost:3500/customers")
      .then(res => res.json())
      .then(customers => {
        const customer = customers.find(
          c => String(c.id) === String(customerId)
        );

        if (!customer) {
          alert("Customer not found");
          return;
        }

        console.log("Customer Data:", customer);

      });




  </script>

</body>

</html>